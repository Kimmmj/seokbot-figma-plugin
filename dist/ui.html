<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column; /* 세로로 나열 */
            gap: 10px; /* 요소 간의 간격 */
        }
        input, select, textarea, button {
            padding: 10px;
            width: 100%; /* 전체 너비 사용 */
            box-sizing: border-box; /* 패딩을 포함한 너비 계산 */
        }
        
        .edit-button,
        .send-button,
        .save-button {
            color: beige;
            background-color: #333;
            border: 1px solid transparent;
            border-radius: 2px;
        }

        .save-button:disabled {
            color: gray; /* 텍스트 색상 변경 */
            background-color: lightgray; /* 배경색 변경 */
            border: 1px solid darkgray; /* 테두리 색상 변경 */
            cursor: not-allowed; /* 커서 변경 */
        }

        .edit-button:hover,
        .send-button:hover {
            background-color: black; /* 원하는 hover 배경색으로 변경 */
        }

        #userInput {
            height: 100px; /* 질문 입력 필드 높이 설정 */
            resize: none; /* 크기 조절 비활성화 */
            overflow: auto; /* 내용이 넘칠 경우 스크롤 가능 */
        }
        .hidden {
            display: none; /* 숨김 클래스 */
        }
    </style>
</head>
<body>
    <input id="tokenInput" type="text" placeholder="OpenAI API Token을 입력하세요" disabled />
    <button id="editToken" class="edit-button">수정</button>
    <button id="saveToken" class="save-button hidden" disabled>저장</button>
    <button id="closeToken" class="hidden">닫기</button>

    <textarea id="userInput" placeholder="confrim 또는 alert 모달에 맞는 적절한 문구를 추천합니다."></textarea>
    
    <!-- 드롭다운 추가 -->
    <select id="componentSelect">
      <option value="Modal / Confirm">Modal / Confirm</option>
      <option value="Modal / Alert">Modal / Alert</option>
    </select>

    <button id="submit" class="send-button">질문 전송</button>
    <p id="result"></p>

    <script>
      let previousToken = ''; // 이전 토큰 값을 저장할 변수
      let currentToken = ''; // 현재 토큰 값을 저장할 변수

        // 페이지 로드 시 클라이언트 스토리지에서 토큰 불러오기
        document.addEventListener('DOMContentLoaded', async () => {
        const tokenInput = document.getElementById('tokenInput');
        const savedToken = await figma.clientStorage.getAsync('openAIToken'); // 클라이언트 스토리지에서 가져오기
        if (savedToken) {
            tokenInput.value = savedToken; // 저장된 토큰을 tokenInput에 설정
            previousToken = savedToken; // 이전 토큰 값 저장
            currentToken = savedToken; // 현재 토큰 값 저장
        } else {
            console.log('저장된 토큰이 없습니다.'); // 디버깅용 로그
        }

        // 수정 버튼 클릭 시
        document.getElementById('editToken').onclick = () => {
            tokenInput.disabled = false; // 입력 필드 활성화
            tokenInput.focus(); // 입력 필드에 포커스
        };

        // 저장 버튼 클릭 시
        document.getElementById('saveToken').onclick = async () => {
            const token = tokenInput.value.trim(); // 입력한 토큰 값 가져오기
            if (!token) {
                alert('유효한 토큰을 입력하세요.'); // 빈 값 체크
                return;
            }

            // 백엔드 코드로 메시지 전달
            parent.postMessage({ pluginMessage: { type: 'set-token', token } }, '*');
        };
        });

        document.getElementById('editToken').onclick = () => {
        const tokenInput = document.getElementById('tokenInput');
        const saveButton = document.getElementById('saveToken');
        const closeButton = document.getElementById('closeToken');

        // 입력 필드 활성화
        tokenInput.disabled = false;
        tokenInput.focus();

        // 저장 버튼과 닫기 버튼 보이기
        saveButton.classList.remove('hidden');
        closeButton.classList.remove('hidden');

        // 수정 버튼 숨기기
        document.getElementById('editToken').classList.add('hidden');

        // 입력값 변경 이벤트 감지
        tokenInput.addEventListener('input', () => {
            const newValue = tokenInput.value.trim(); // 입력값 (공백 제거)

            // 입력값이 이전 값과 다르면 저장 버튼 활성화
            if (newValue !== previousToken) {
            saveButton.disabled = false; // 저장 버튼 활성화
            } else {
            saveButton.disabled = true; // 저장 버튼 비활성화
            }
        });
        };

        // 저장 버튼 클릭 시
        document.getElementById('saveToken').onclick = async () => {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value.trim(); // 입력값 가져오기
            
            if (!token) {
            alert('토큰을 입력해주세요.');
            return;
            }

            // TypeScript 코드로 메시지 전달
            parent.postMessage(
                { pluginMessage: { type: 'save-token', token } },
                '*'
            );
        };

        // 닫기 버튼 클릭 시
        document.getElementById('closeToken').onclick = () => {
        const tokenInput = document.getElementById('tokenInput');

        // 저장 버튼과 닫기 버튼 숨기기
        document.getElementById('saveToken').classList.add('hidden');
        document.getElementById('closeToken').classList.add('hidden');

        // 수정 버튼 보이기
        document.getElementById('editToken').classList.remove('hidden');
        };

        // Figma에서 전달된 데이터를 처리
        window.onmessage = (event) => {
        const pluginMessage = event.data.pluginMessage || {}; // pluginMessage를 별도로 추출
        const { type: messageType, token } = pluginMessage; // 첫 번째 선언: type을 messageType으로 변경
        
        if (messageType === 'load-token') {
            const tokenInput = document.getElementById('tokenInput');
            tokenInput.value = token || ''; // 저장된 토큰을 입력 필드에 설정
            currentToken = token || ''; // 현재 토큰 값 업데이트
            previousToken = token || ''; // 이전 토큰 값도 업데이트
        }

        const { type: actionType, success, error } = pluginMessage; // 두 번째 선언: type을 actionType으로 변경

        if (actionType === 'token-saved') {
            if (success) {
            alert('토큰이 성공적으로 저장되었습니다.');
            document.getElementById('tokenInput').disabled = true;
            document.getElementById('saveToken').classList.add('hidden');
            document.getElementById('closeToken').classList.add('hidden');
            document.getElementById('editToken').classList.remove('hidden');
            } else {
            alert(`토큰 저장 중 오류가 발생했습니다: ${error}`);
            }
        }
        };

        // 질문 전송
        document.getElementById('submit').onclick = () => {
        const question = document.getElementById('userInput').value;
        const selectedComponent = document.getElementById('componentSelect').value;

        parent.postMessage({ pluginMessage: { type: 'submit-question', question, component: selectedComponent } }, '*');
        };
    </script>
</body>
</html>
